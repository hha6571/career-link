<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.career.careerlink.main.mapper.MainMapper">

    <select id="selectMainJobs" resultType="map">
        SELECT
            h.job_posting_id AS jobId,
            h.title AS title,
            e.company_name AS companyName,
            e.company_logo_url AS companyLogoUrl,
            COALESCE(jfc.code_name,  h.job_field_code)         AS jobField,
            COALESCE(loc.code_name,  h.location_code)          AS location,
            COALESCE(emt.code_name,  h.employment_type_code)   AS employmentType,
            COALESCE(car.code_name,  h.career_level_code)      AS experience,
            COALESCE(edu.code_name,  h.education_level_code)   AS education,
            COALESCE(sal.code_name,  h.salary_code)            AS salary,
            h.application_deadline AS deadline,
            h.view_count AS viewCount,
            h.app_count as appCount
        FROM (
                 SELECT
                     jp.job_posting_id,
                     jp.employer_id,
                     jp.title,
                     jp.job_field_code,
                     jp.location_code,
                     jp.employment_type_code,
                     jp.education_level_code,
                     jp.career_level_code,
                     jp.salary_code,
                     jp.application_deadline,
                     jp.view_count,
                     count(app.application_id) AS app_count
                 FROM job_postings jp
                          LEFT OUTER JOIN applications app
                                          ON jp.job_posting_id = app.job_posting_id
                                              AND app.status = 'SUBMITTED'
                 WHERE jp.is_active = 'Y'
                   AND jp.is_deleted = 'N'
                 GROUP BY jp.job_posting_id,
                          jp.employer_id,
                          jp.title,
                          jp.job_field_code,
                          jp.location_code,
                          jp.employment_type_code,
                          jp.education_level_code,
                          jp.career_level_code,
                          jp.salary_code,
                          jp.application_deadline,
                          jp.view_count
                 ORDER BY app_count DESC
                     LIMIT 12
             ) h
                 JOIN employers e
                      ON e.employer_id = h.employer_id
                 LEFT JOIN common_codes jfc
                           ON jfc.group_code = 'JOB_FIELD'
                               AND jfc.code       = h.job_field_code
                 LEFT JOIN common_codes loc
                           ON loc.group_code = 'LOCATION'
                               AND loc.code       = h.location_code
                 LEFT JOIN common_codes emt
                           ON emt.group_code = 'EMPLOYMENT_TYPE'
                               AND emt.code       = h.employment_type_code
                 LEFT JOIN common_codes edu
                           ON edu.group_code = 'EDUCATION_LEVEL'
                               AND edu.code       = h.education_level_code
                 LEFT JOIN common_codes car
                           ON car.group_code = 'CAREER_LEVEL'
                               AND car.code       = h.career_level_code
                 LEFT JOIN common_codes sal
                           ON sal.group_code = 'SALARY'
                               AND sal.code       = h.salary_code
        ORDER BY h.app_count DESC, h.job_posting_id DESC
            LIMIT 12
    </select>

    <select id="selectMainEmployers" resultType="map">
        SELECT
            ep.employer_id      AS employerId,
            ep.company_name     AS companyName,
            ep.company_logo_url AS companyLogoUrl,
            COUNT(jp.job_posting_id) AS postingCount
        FROM employers ep
        LEFT JOIN job_postings jp
            ON jp.employer_id = ep.employer_id
            AND jp.is_deleted = 'N'
            AND jp.is_active = 'Y'
            AND jp.application_deadline <![CDATA[>=]]> SYSDATE()
        GROUP BY
            ep.employer_id, ep.company_name, ep.company_logo_url
        HAVING
            postingCount > 0
        ORDER BY
            postingCount DESC, ep.company_name ASC
            LIMIT 30
    </select>
</mapper>
